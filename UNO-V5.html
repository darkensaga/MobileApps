<!-- ========================================================================== -->
<!-- ==  UNO: OneInTheSleeve : https://blinding-fire-9286.firebaseIO.com     == -->
<!-- ==       Colors: Grn:669933, Blu:3366CC, Red:FF0033, Yel: FFCC00        == -->
<!-- ========================================================================== -->
<!DOCTYPE html>
<html>
  <head>
  <title>UNO Game - OneInTheSleeve</title>
  <!-- <meta  name="viewport"  content="width=device-width, initial-scale=1, maximum-scale=1"> -->
  <link  href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
  <link  rel="stylesheet" href="css/UNO_styles.css"/>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.7.1/modernizr.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.6/angular.min.js'></script>
    <script src='https://cdn.firebase.com/js/client/1.0.11/firebase.js'></script>
    <script src='https://cdn.firebase.com/libs/angularfire/0.7.1/angularfire.min.js'></script>
    <script src="https://cdn.firebase.com/v0/firebase.js"></script>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.1.min.js"></script>
    <style  type="text/css"> #cardCanvas {border: dotted 3px black;  background-color: green;} </style>

  </head>
<!-- ========================================================================== -->  
  <body>
    <!-- <table> <tr> <td> <input type="button" value="Draw Card - Player 1" id="btnDrawCard1" /> 
                      <input type="button" value="Draw Card - Player 2" id="btnDrawCard2" /> 
                      <input type="button" value="Draw Card - Player 3" id="btnDrawCard3" /> 
                      <input type="button" value="Draw Card - Player 4" id="btnDrawCard4" />
                      <input type="button" value="Draw Card - Discard"  id="btnDrawCardD" />
                      <input type="button" value="Center Player 1 Hand" id="btnCenterP1Hand" />

                      </td> </tr> </table>  -->
    <!-- <div id="kineticContainer">
      <canvas id="kineticCanvas" width="1136px" height="640"> </canvas>
    </div> -->
    <div id="canvasContainer">
      <canvas id="cardCanvas" width="1136px" height="640"> </canvas>
    </div>
     
<!-- =================================================================== -->
  <script>
     var ctxh   = cardCanvas.height;  // 640;    // canvas height
     var ctxw   = cardCanvas.width;   // 1136;   // canvas width
     var cardw  = 90;
     var cardh  = 139;
     var offset = 64;     // offset cards in hand by 70px (more cards on table)
     var pad    = 35;     // border around edge of canvas for player names
     var midw   = ctxw/2-(cardw/2);
     var midh   = ctxh/2-(cardh/2);
     var left   = 20;
     var right  = ctxw-cardw-20;
     var bot    = ctxh-cardh-25;
     var p1cardCt = -1, p2cardCt = -1, p3cardCt=-1, p4cardCt = -1; pDcardCt = -1;
     var rectY  = 200, rectW = 40;
     var rectX  = -rectW;

// _______________________________________ MAIN FUNCTION _____________________
    (function() {
        var suit = { blu: 'blu', grn: 'grn', red: 'red', yel: 'yel'};

        if (Modernizr.canvas) { 
          var cardCanvas = document.getElementById("cardCanvas");
          var context    = cardCanvas.getContext("2d"); }
        else  { alert("Canvas is not supported"); }; 
        // ___________________________________________ Player 1 Name ----
        context.font = 'italic 20pt Calibri';
        context.fillStyle = 'white';
        context.textAlign = "center";
        context.fillText('Player 1', ctxw/2, ctxh-10); 
        // ___________________________________________ Player 2 Name ----
        context.fillStyle = 'yellow';
        context.save();
        context.translate(10, 0);
        context.rotate(Math.PI/2); 
        context.fillText('Player 2', ctxh/2, 0);
        context.restore(); 
        // ___________________________________________ Player 3 Name ----
        context.fillStyle = 'yellow';
        context.fillText('Player 3', ctxw/2, 25);
        // ___________________________________________ Player 4 Name ----
        context.fillStyle = 'yellow';
        context.save();
        context.translate(ctxw, 0);
        context.rotate(-Math.PI/2); 
        context.fillText('Player 4', -ctxh/2, -10);
        context.restore(); 
      // _____________________________________________ display deck ___
      var deckImage    = new Image();
      deckImage.onload = function () { context.drawImage(deckImage, ctxw/2-cardw-30, midh, 90, 139);};
      deckImage.src    = '../UNO-App/images/Deck_110.png';

      // _____________________________________________ clicked deck?___
      document.getElementById("cardCanvas").addEventListener("click", function(evt) {
        //context.font = "bold 16px Arial";
        var mousePos = getMousePos(cardCanvas, evt);
        //var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
        if (mousePos.x > ctxw/2-cardw-30 && mousePos.x < ctxw/2-30 &&
            mousePos.y > midh            && mousePos.y < midh+cardh)
            //document.body.style.cursor = 'pointer';
            //context.fillText("X: " + mousePos.x + " Y: " + Math.round(mousePos.y), mousePos.x, mousePos.y);
            drawCard1();
        }, false); 
      //__________________________________
  /*    yellowSquare();
      //__________________________________
      function yellowSquare() {
        //blank();
        context.fillStyle = "yellow";
        context.fillRect(rectX, rectY, rectW, rectW);
        setInterval(anim,30);
      } */
      //__________________________________
  /*    function blank() {
        context.fillStyle = "#00ddee";
        context.fillRect(0,0,context.canvas.width, ctxw)
      }
      //__________________________________
      function anim() {
       // if (rectX < context.canvas.width) {
           //blank();
        if (rectX < 300) {
           context.fillStyle   = "green";
           context.fillRect(rectX-5, rectY, 5, 40);

           rectX += 5;
           context.fillStyle   = "yellow";
           context.strokeStyle = "red";
           context.lineWidth   = 3;
           context.fillRect(rectX, rectY, rectW, rectW);
        }
        else rectX=-rectW;
      } */
      // __________________________________ Blank P1 Hand with green _______
      function blankP1Hand() {
           context.fillStyle   = "green";
           context.fillRect(200, ctxh-cardh-pad, ctxw-400, cardh);  
      }
      // __________________________________ Move P1 Hand left ______________
      function centerP1Hand() { 
      var player1Hand=context.getImageData(200,ctxh-cardh-pad,ctxw-200,cardh);
      context.putImageData(player1Hand, 200-offset/2, ctxh-cardh-pad);
      }
      // __________________________________ Move P1 Hand left handler _______
      $("#btnCenterP1Hand").on("click", function() { 
        centerP1Hand();
      });
//======= Use KineticJS to move images ======================================
  /*    function moveImage(imageObj) { 
        var stage = new Kinetic.Stage({
          container: "kineticContainer",   // "container",
          width: 1136,
          height: 640
        });
        var layer = new Kinetic.Layer();

        // ____ card back ____
        var cardBackImg = new Kinetic.Image({
          image: imageObj,
          x: stage.getWidth() / 2 - 200 / 2,
          y: stage.getHeight() / 2 - 137 / 2,
          width: 90,
          height: 139,
          draggable: true
        });
      // ____ change cursor _____
        cardBackImg.on('mouseover', function() {document.body.style.cursor = 'pointer';});
        cardBackImg.on('mouseout',  function() {document.body.style.cursor = 'default';});
        layer.add(cardBackImg);
        stage.add(layer);
      }
      var imageObj    = new Image();
      imageObj.onload = function() {moveImage(this);};
      imageObj.src    = '../UNO-App/images/Deck_110.png';  */

    //____________________________________
      function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }
//===========================================================================
    // ___________________________________
      function Card(name, suit, card, pic) {
        this.Name = name;
        this.Suit = suit;
        this.Card = card;
        this.Pic  = pic;
      } 
    // ___________________________________
      Card.prototype.toString = function () {
        var value = "No color for this card";
        switch(this.Suit) { case suit.blu: value = "Blue gengian";  break;
                            case suit.grn: value = "Green goddess"; break;
                            case suit.red: value = "Red ruby";      break;
                            case suit.yel: value = "Yellow bird";   break; }
        return this.Name + " of " + value;
      }
    // ___________________________________
var UNO      = new Firebase('https://blinding-fire-9286.firebaseIO.com');
var deck     = new Firebase('https://blinding-fire-9286.firebaseIO.com/deck');
var _origDeck= new Firebase('https://blinding-fire-9286.firebaseIO.com/_origDeck');
var player1  = new Firebase('https://blinding-fire-9286.firebaseIO.com/player1');
var player2  = new Firebase('https://blinding-fire-9286.firebaseIO.com/player2');
var player3  = new Firebase('https://blinding-fire-9286.firebaseIO.com/player3');
var player4  = new Firebase('https://blinding-fire-9286.firebaseIO.com/player4');
var discard  = new Firebase('https://blinding-fire-9286.firebaseIO.com/discard');

var cardDeck;  // Global variable
var p1 = [];   // Global variable (not in firebase - only here in pgm)
var p2 = [];   // Global variable (not in firebase - only here in pgm)
var p3 = [];   // Global variable (not in firebase - only here in pgm)
var p4 = [];   // Global variable (not in firebase - only here in pgm)
var discardPile = [];  // Global variable (not in firebase - only here in pgm)
offset = 32;   

var deal = true; 

// _____ deal 7 cards to each of 4 players & 1 card to discard _____
  _origDeck.on('value', function(getCards) { 
    cardDeck = getCards.val();
    UNO.update({"deck" : cardDeck });   // copy all 108 cards from origDeck to deck

    for (var i=0; i<7 ;i++) { 
        drawCard1(); drawCard2(); drawCard3(); drawCard4();
      }
    drawCardD();
    UNO.update({"player1" : p1 });
    UNO.update({"player2" : p2 });
    UNO.update({"player3" : p3 });
    UNO.update({"player4" : p4 }); 
    UNO.update({"deck"    : cardDeck });  // copy local cardDeck to fireBase
    UNO.update({"discard" : discardPile });
    deal = false;
  });

    // ___________________________________
      function drawRandomCard() {
        //context.fillStyle   = "Green";   // erase text
        //context.fillRect(650, 70, 620, 160);
        deckElementNum = Math.floor(Math.random() * cardDeck.length);
        deckElementVal = cardDeck[deckElementNum];
        //context.font="20px Georgia";
        //context.fillStyle   = "Orange";
        //context.fillText("Card @: " + deckElementNum + " = " + deckElementVal, 775, 90);
        //context.fillText("Deck Length: " + cardDeck.length, 950,90);    
        return cardDeck[deckElementNum];
      }
// +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    // _____________________________________________________ Player 1 __________
      function drawCard1() {
        if (context) {
           var curCard1 = drawRandomCard();
           if (curCard1) { 
              var curImage = new Image();
              curImage.onload = function () {
                    // move player cards to left 1/2 offset
                var player1Hand=context.getImageData(200,ctxh-cardh-pad,ctxw-200,cardh);
                context.putImageData(player1Hand, 200-2*offset, ctxh-cardh-pad);
                context.font="20px Georgia";
                context.fillStyle   = "White";
                context.fillText(p1.length, 900,200);
                    // add new card to player 1 hand
                context.drawImage(curImage, midw + (p1.length)*offset, ctxh-cardh-pad, 90, 139); };
                //-----
                curImage.src = '../UNO-App/images/' + curCard1 + '.png';     // was curCard1.name
                //~~~~~~~~~~~~~~~~~~~~~~~~~~~
                //context.font="20px Georgia";
                //context.fillStyle   = "White";
                //context.fillText("elementNum: " + deckElementNum, 900,120);
                //context.fillText("Deck = " + cardDeck + " -- " + curCard1, 900, 150); //ctxw/2+150,ctxh/2);
                //context.fillText("curCard1 = " + curCard1 + "  Len: " + cardDeck.length, 900, 125);
                //~~~~~~~~~~~~~~~~~~~~~~~~~~~
                cardDeck.splice(deckElementNum, 1);  // remove card from deck
                //context.fillText("Deck = " + cardDeck + " -- " + curCard1, 900, 175);
                //context.fillText("curCard1 = " + curCard1 + "  Len: " + cardDeck.length, 900, 150);
                p1.push(curCard1);
                if (deal == false) {
                  UNO.update({"deck"    : cardDeck });
                  UNO.update({"player1" : p1 });
                }
          }
          else {alert("Out of Cards")};     // got to put discard pile back in deck
        } }
    // _________________________
      $("#btnDrawCard1").on("click", function() { 
        drawCard1();
      });
    // _____________________________________________________ Player 2 __________
      function drawCard2() {
        if (context) {
           var curCard2 = drawRandomCard();
           if (curCard2) { 
              var curImage = new Image();
              curImage.onload = function () {
                context.save();  
                context.translate(cardh, 0)
                context.rotate(1.57);
                context.drawImage(curImage, ctxh/2-cardw/2, -pad, 90, 139);
                context.restore();    
              };
              //context.clearRect(x_img1,y_img1, x_img1+img1.width, y_of_img1 + img1.height );
              // context.drawImage(curImage, left, midh); };
              curImage.src = '../UNO-App/images/' + curCard2 + '.png';
              cardDeck.splice(deckElementNum, 1);  // remove card from deck   
              p2.push(curCard2);
              if (deal == false) { 
                UNO.update({"deck"    : cardDeck });
                UNO.update({"player2" : p2 });
              } }
          else {alert("Out of Cards")};   // got to put discard pile back in deck
        } }
    // _________________________
      $("#btnDrawCard2").on("click", function() { 
        context.fillText("Lets call card 2.", 950, 66);
        drawCard2();
      });
    // _____________________________________________________ Player 3 __________
      function drawCard3() {
        if (context) {
           var curCard3 = drawRandomCard();
           if (curCard3) { 
              var curImage = new Image();
              curImage.onload = function () {

                    // move player cards to left 1/2 offset
                var player3Hand=context.getImageData(200, pad, ctxw-200, cardh+pad);
                context.putImageData(player3Hand, 200-offset, pad);
                    // add new card to player 1 hand
                context.drawImage(curImage, midw + (p3.length)*offset, pad, 90, 139); };

                //context.drawImage(curImage, midw, pad, 90, 139); };
                curImage.src = '../UNO-App/images/' + curCard3 + '.png';
                cardDeck.splice(deckElementNum, 1);  // remove card from deck
                p3.push(curCard3);
                if (deal == false) {
                  UNO.update({"deck"    : cardDeck });
                  UNO.update({"player3" : p3 });   
                  } }
          else {alert("Out of Cards")};     // got to put discard pile back in deck
        } }
    // _________________________
      $("#btnDrawCard3").on("click", function() { 
        drawCard3();
      });
    // _____________________________________________________ Player 4 __________
      function drawCard4() {
        if  (context) {
            var curCard4 = drawRandomCard();
            if  (curCard4) { 
                var curImage = new Image();
                curImage.onload = function () {
                  context.save();
                  context.translate(ctxw, 0);
                  context.rotate(-Math.PI/2); 
                  context.drawImage(curImage, -ctxh/2-cardw/2, -cardh-pad, 90, 139);
                  context.restore();  
                };
              curImage.src = '../UNO-App/images/' + curCard4 + '.png'; 
              cardDeck.splice(deckElementNum, 1);           // remove card from deck  
              p4.push(curCard4);                            // put card in player 3's hand
              if (deal == false) {
                UNO.update({"deck"    : cardDeck });
                UNO.update({"player4" : p4 });  // update firebase            
            } }
            else {alert("Out of Cards")};   // got to put discard pile back in deck
        } }
    // _________________________
      $("#btnDrawCard4").on("click", function() { 
        drawCard4();
      });
    // _____________________________________________________ Discard __________
      function drawCardD() {
        if  (context) {
            var curCardD = drawRandomCard();
            if  (curCardD) { 
                var curImage = new Image();
                curImage.onload = function () {
                  context.drawImage(curImage, ctxw/2+10, midh, 90, 139);  };          
                  curImage.src = '../UNO-App/images/' + curCardD + '.png';
                  cardDeck.splice(deckElementNum, 1);  // remove card from deck
                  discardPile.push(curCardD); 
                    //context.font="20px Georgia";
                    //context.fillStyle   = "White";
                    //context.fillText("discardPile: " + discardPile, 900,120);  
                  if (deal == false) {
                    UNO.update({"deck"    : cardDeck });     // update firebase
                    UNO.update({"discard" : discardPile });  // update firebase            
                  }  } 
            else {alert("Out of Cards")};   // got to put discard pile back in deck
        } }
    // _________________________
      $("#btnDrawCardD").on("click", function() { 
        drawCardD();
      });
// ___________________________________
}()) // End major function

    </script>
  </body>
</html>